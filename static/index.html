<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xalora AI Interview System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .content { padding: 40px; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        textarea { min-height: 100px; resize: vertical; }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #6c757d; }
        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
        }
        .file-upload input[type="file"] { display: none; }
        .question-box {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }
        .progress-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s;
        }
        .round-card {
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            margin: 10px;
            display: inline-block;
            width: 200px;
        }
        .round-card:hover { border-color: #667eea; transform: translateY(-5px); }
        .round-card.active { border-color: #667eea; background: #f5f5ff; }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .report-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Xalora AI Interview System</h1>
            <p>Resume-Based Adaptive Interview Platform</p>
        </div>

        <div class="content">
            <!-- Section 1: Candidate Info -->
            <div id="section-info" class="section active">
                <h2>üë§ Candidate Information</h2>
                <form id="candidateForm">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="name" required>
                    </div>
                    <div class="form-group">
                        <label>Age *</label>
                        <input type="number" id="age" min="18" max="100" required>
                    </div>
                    <div class="form-group">
                        <label>Gender *</label>
                        <select id="gender" required>
                            <option value="">Select</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Experience *</label>
                        <input type="text" id="experience" placeholder="e.g., 3 years" required>
                    </div>
                    <div class="form-group">
                        <label>Upload Resume (PDF) *</label>
                        <div class="file-upload" onclick="document.getElementById('resumeFile').click()">
                            <p>üìÑ Click to upload resume</p>
                            <input type="file" id="resumeFile" accept=".pdf" required>
                        </div>
                        <p id="fileName" style="margin-top: 10px; color: #667eea;"></p>
                    </div>
                    <div class="form-group">
                        <label>Job Description *</label>
                        <textarea id="jobDescription" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Company Type *</label>
                        <select id="companyType" required>
                            <option value="">Select</option>
                            <option value="startup">Startup (Easy DSA)</option>
                            <option value="service_based">Service Based (Moderate DSA)</option>
                            <option value="product_based">Product Based (Hard DSA)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Interview Mode *</label>
                        <select id="interviewMode" required>
                            <option value="">Select</option>
                            <option value="full">Full Interview (Must pass coding)</option>
                            <option value="practice">Practice Specific Round</option>
                        </select>
                    </div>
                    <button type="submit" class="btn">Start Interview üöÄ</button>
                </form>
            </div>

            <!-- Section 2: Round Selection -->
            <div id="section-rounds" class="section">
                <h2>üìã Select Round</h2>
                <div id="analysisResult" class="alert alert-success" style="display: none;"></div>
                <div id="modeMessage" style="margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 8px;"></div>
                
                <!-- Coding Difficulty Selection (shown only for coding round) -->
                <div id="codingDifficultySection" style="display: none; margin: 20px 0; padding: 20px; background: #fff3cd; border-radius: 8px;">
                    <h3>üéØ Select Coding Difficulty</h3>
                    <select id="codingDifficulty" style="width: 100%; padding: 10px; font-size: 16px;">
                        <option value="easy">Easy - Basic Arrays, Strings, Loops</option>
                        <option value="medium">Medium - Trees, Graphs, Basic DP</option>
                        <option value="hard">Hard - Advanced DP, Complex Algorithms</option>
                    </select>
                    <button class="btn" onclick="startCodingRound()" style="margin-top: 10px;">Start Coding Round</button>
                    <button class="btn btn-secondary" onclick="hideCodingDifficulty()">Cancel</button>
                </div>
                
                <div style="text-align: center;">
                    <div class="round-card" onclick="selectRound('formal_qa', 20)">
                        <h3>üíº</h3>
                        <p>Formal Q&A</p>
                        <small>20 Questions</small>
                    </div>
                    <div class="round-card" onclick="showCodingDifficulty()">
                        <h3>üíª</h3>
                        <p>Coding</p>
                        <small>10 DSA Problems</small>
                    </div>
                    <div class="round-card" onclick="selectRound('technical', 50)">
                        <h3>üî¨</h3>
                        <p>Technical</p>
                        <small>50 Questions</small>
                    </div>
                    <div class="round-card" onclick="selectRound('behavioral', 20)">
                        <h3>üó£Ô∏è</h3>
                        <p>Behavioral</p>
                        <small>20 Questions</small>
                    </div>
                    <div class="round-card" onclick="selectRound('system_design', 20)">
                        <h3>üèóÔ∏è</h3>
                        <p>System Design</p>
                        <small>20 Questions</small>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="generateFinalReport()">üìä Generate Final Report</button>
                </div>
            </div>

            <!-- Section 3: Interview -->
            <div id="section-interview" class="section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="question-box">
                    <h3>Question <span id="qNum">1</span></h3>
                    <p id="questionText" style="white-space: pre-wrap;">Loading...</p>
                </div>
                
                <!-- Test Cases Display (for coding round) -->
                <div id="testCasesDisplay" style="display: none; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h4>üìã Test Cases</h4>
                    <div id="testCasesList"></div>
                </div>
                
                <!-- Test Results Display (after submission) -->
                <div id="testResultsDisplay" style="display: none; margin: 20px 0; padding: 20px; border-radius: 8px;">
                    <h4>üß™ Test Results</h4>
                    <div id="testResultsList"></div>
                </div>
                
                <div class="form-group">
                    <label>Your Answer</label>
                    <textarea id="answerText" rows="8"></textarea>
                </div>
                <button class="btn" onclick="submitAnswer()">Submit Answer ‚úì</button>
                <button class="btn btn-secondary" onclick="skipRound()">Skip Round ‚è≠Ô∏è</button>
                <button class="btn btn-secondary" onclick="completeRound()">Complete Round</button>
            </div>

            <!-- Section 4: Report -->
            <div id="section-report" class="section">
                <h2>üìä Final Report</h2>
                <div id="reportContent" class="report-section">Loading...</div>
                <button class="btn btn-secondary" onclick="location.reload()">New Interview</button>
            </div>
        </div>
    </div>

    <script>
        let sessionId = null;
        let currentRound = null;
        let questionCount = 0;
        let maxQuestions = 0;
        let interviewMode = null;
        let currentQuestionData = null;
        let selectedCodingDifficulty = 'medium';

        document.getElementById('resumeFile').addEventListener('change', function(e) {
            document.getElementById('fileName').textContent = `Selected: ${e.target.files[0]?.name}`;
        });

        document.getElementById('candidateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('name', document.getElementById('name').value);
            formData.append('age', document.getElementById('age').value);
            formData.append('gender', document.getElementById('gender').value);
            formData.append('experience', document.getElementById('experience').value);
            formData.append('job_description', document.getElementById('jobDescription').value);
            formData.append('company_type', document.getElementById('companyType').value);
            formData.append('interview_mode', document.getElementById('interviewMode').value);
            formData.append('resume_file', document.getElementById('resumeFile').files[0]);

            interviewMode = document.getElementById('interviewMode').value;

            try {
                const response = await fetch('/api/start-interview', { method: 'POST', body: formData });
                const data = await response.json();
                
                if (data.success) {
                    sessionId = data.session_id;
                    const analysis = data.resume_analysis;
                    document.getElementById('analysisResult').innerHTML = `
                        <h3>‚úÖ Resume Analyzed!</h3>
                        <p><strong>Skills:</strong> ${analysis.extracted_skills?.join(', ') || 'N/A'}</p>
                    `;
                    document.getElementById('analysisResult').style.display = 'block';
                    
                    // Show mode message
                    const modeMsg = document.getElementById('modeMessage');
                    if (interviewMode === 'full') {
                        modeMsg.innerHTML = '<strong>üìù Full Interview Mode:</strong> Complete any rounds you want. You can skip rounds and come back later. Generate final report when done.';
                    } else {
                        modeMsg.innerHTML = '<strong>üéØ Practice Mode:</strong> Choose any round to practice independently. Generate report for completed rounds.';
                    }
                    
                    showSection('section-rounds');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        function showCodingDifficulty() {
            document.getElementById('codingDifficultySection').style.display = 'block';
        }
        
        function hideCodingDifficulty() {
            document.getElementById('codingDifficultySection').style.display = 'none';
        }
        
        function startCodingRound() {
            selectedCodingDifficulty = document.getElementById('codingDifficulty').value;
            hideCodingDifficulty();
            selectRound('coding', 10);
        }
        
        async function selectRound(round, count) {
            currentRound = round;
            maxQuestions = count;
            questionCount = 0;
            document.getElementById('testCasesDisplay').style.display = 'none';
            document.getElementById('testResultsDisplay').style.display = 'none';
            showSection('section-interview');
            getNextQuestion();
        }
        
        async function skipRound() {
            if (confirm('Are you sure you want to skip this round? You can come back to it later.')) {
                showSection('section-rounds');
            }
        }

        async function getNextQuestion() {
            if (questionCount >= maxQuestions) {
                alert('Round complete! You can select another round or generate final report.');
                showSection('section-rounds');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('session_id', sessionId);
                formData.append('round_type', currentRound);
                formData.append('question_count', maxQuestions);
                
                // Add coding difficulty if coding round
                if (currentRound === 'coding') {
                    formData.append('coding_difficulty', selectedCodingDifficulty);
                }

                const response = await fetch('/api/get-question', { method: 'POST', body: formData });
                const data = await response.json();
                
                if (data.success) {
                    questionCount = data.question_number;
                    currentQuestionData = data.question_data;
                    
                    document.getElementById('qNum').textContent = questionCount;
                    document.getElementById('questionText').textContent = data.question;
                    document.getElementById('answerText').value = '';
                    document.getElementById('testResultsDisplay').style.display = 'none';
                    
                    const progress = (questionCount / maxQuestions) * 100;
                    document.getElementById('progressBar').style.width = progress + '%';
                    
                    // Show test cases for coding round
                    if (currentRound === 'coding' && data.question_data.test_cases) {
                        displayTestCases(data.question_data.test_cases);
                    } else {
                        document.getElementById('testCasesDisplay').style.display = 'none';
                    }
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function displayTestCases(testCases) {
            const testCasesDiv = document.getElementById('testCasesList');
            const visibleCases = testCases.visible || [];
            
            let html = '<div style="background: white; padding: 15px; border-radius: 8px;">';
            visibleCases.forEach((tc, idx) => {
                html += `
                    <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-left: 3px solid #667eea;">
                        <strong>Test Case ${idx + 1}:</strong><br>
                        <strong>Input:</strong> <code>${tc.input}</code><br>
                        <strong>Expected Output:</strong> <code>${tc.expected_output}</code>
                        ${tc.explanation ? `<br><strong>Explanation:</strong> ${tc.explanation}` : ''}
                    </div>
                `;
            });
            html += '</div>';
            
            testCasesDiv.innerHTML = html;
            document.getElementById('testCasesDisplay').style.display = 'block';
        }

        async function submitAnswer() {
            const answer = document.getElementById('answerText').value.trim();
            if (!answer) {
                alert('Please provide an answer');
                return;
            }

            try {
                // For coding round, evaluate the code first
                if (currentRound === 'coding') {
                    const formData = new FormData();
                    formData.append('session_id', sessionId);
                    formData.append('code', answer);
                    
                    const response = await fetch('/api/evaluate-coding', { method: 'POST', body: formData });
                    const data = await response.json();
                    
                    if (data.success) {
                        // Display test results
                        displayTestResults(data.test_results);
                        
                        if (data.all_passed) {
                            alert('‚úÖ All test cases passed! Great job!');
                            // Store answer and move to next
                            await storeAnswer(answer);
                            await getNextQuestion();
                        } else {
                            const retry = confirm(`‚ùå ${data.passed_count}/${data.total_count} test cases passed.\n\nWould you like to try again? (Click Cancel to move to next problem)`);
                            if (!retry) {
                                // Store answer and move to next
                                await storeAnswer(answer);
                                await getNextQuestion();
                            }
                            // If retry, keep the same question
                        }
                        return;
                    }
                }
                
                // For non-coding rounds, just store and move to next
                await storeAnswer(answer);
                await getNextQuestion();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function storeAnswer(answer) {
            const formData = new FormData();
            formData.append('session_id', sessionId);
            formData.append('round_type', currentRound);
            formData.append('answer', answer);

            const response = await fetch('/api/submit-answer', { method: 'POST', body: formData });
            const data = await response.json();
            
            return data.success;
        }
        
        function displayTestResults(testResults) {
            const resultsDiv = document.getElementById('testResultsList');
            
            let html = '<div style="padding: 15px; border-radius: 8px;">';
            testResults.forEach((result, idx) => {
                const bgColor = result.passed ? '#d4edda' : '#f8d7da';
                const icon = result.passed ? '‚úÖ' : '‚ùå';
                const status = result.passed ? 'PASSED' : 'FAILED';
                
                html += `
                    <div style="margin-bottom: 10px; padding: 12px; background: ${bgColor}; border-radius: 6px;">
                        <strong>${icon} Test Case ${idx + 1}: ${status}</strong><br>
                        <strong>Input:</strong> <code>${result.input}</code><br>
                        <strong>Expected:</strong> <code>${result.expected}</code><br>
                        <strong>Your Output:</strong> <code>${result.actual}</code>
                        ${result.error ? `<br><strong>Error:</strong> ${result.error}` : ''}
                    </div>
                `;
            });
            html += '</div>';
            
            resultsDiv.innerHTML = html;
            document.getElementById('testResultsDisplay').style.display = 'block';
            document.getElementById('testResultsDisplay').style.background = '#fff';
        }

        async function completeRound() {
            if (confirm('Complete this round and return to round selection?')) {
                showSection('section-rounds');
            }
        }

        async function generateFinalReport() {
            if (confirm('Generate final report for all completed rounds?')) {
                await generateReport();
            }
        }

        async function generateReport() {
            showSection('section-report');
            document.getElementById('reportContent').textContent = 'Generating comprehensive report for all completed rounds...';

            try {
                const formData = new FormData();
                formData.append('session_id', sessionId);

                const response = await fetch('/api/final-report', { method: 'POST', body: formData });
                const data = await response.json();
                
                if (data.success) {
                    const report = data.report;
                    document.getElementById('reportContent').textContent = report.comprehensive_analysis;
                }
            } catch (error) {
                document.getElementById('reportContent').textContent = 'Error generating report: ' + error.message;
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }
    </script>
</body>
</html>